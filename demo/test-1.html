<html>
    <head>
        <script type="text/javascript" src="../src/cycle.js"></script>
        <script type="text/javascript" src="../src/engine.js"></script>
        <script type="text/javascript" src="../src/render/pixel.js"></script>
        <script type="text/javascript" src="../src/anims/inquisition.js"></script>
        <script type="text/javascript" src="../src/updater.js"></script>
        <script type="text/javascript" src="../src/browser.js"></script>
        <script type="text/javascript" src="../src/logger.js"></script>
        <script type="text/javascript" src="../src/loop.js"></script>
        <style>
            #board {
                background-color: #eee;
            }
            </style>
    </head>
    <body>
        <button data-action="loop-start">Loop start</button>
        <button data-action="loop-pause">Loop pause</button>
        <button data-action="hide-logs">Toggle logs</button>
        FPS:
        <input type="text" data-action="set-fps" />
        <span data-display="crap">┬─┬ノ( º _ ºノ)</span>
        <div id="fpsData">
            <span id="fps"></span> fps <br />
            <span id="T"></span> ms/frame
        </div>
        
        <canvas id="board" width="1024" height="600"></canvas>

        <script type="text/javascript">
            document.addEventListener("DOMContentLoaded", function() {
                var initialFPS = 30,
                    engine = new Engine(document.querySelector("#board")),
                    loop = new Loop(initialFPS, engine),
                    logger = new Logger("info", false),
                    err = null,
                    shittyFps = {
                        m: 0,
                        cT: 0
                    };

                    (new Browser())
                        .onDocumentHidden(loop.pause.bind(loop))
                        .onDocumentVisible(loop.start.bind(loop))
                        .onBlur(function(){document.querySelector('[data-display="crap"]').innerHTML = '(╯°□°）╯︵ ┻━┻';})
                        .onFocus(function(){document.querySelector('[data-display="crap"]').innerHTML = '┬─┬ノ( º _ ºノ)';});

                    err = loop.dataUpdater.add(logger.log.bind(logger));
                    if (err != null) {
                        console.error(err)
                    }

                    err = loop.dataUpdater.add(function(T) {
                        shittyFps.cT += T;
                        shittyFps.m++;
                        document.querySelector("#T").innerHTML = T.toFixed(4);

                        if (shittyFps.cT >= 100) {
                            document.querySelector("#fps").innerHTML = ((shittyFps.m / shittyFps.cT) * 1000).toFixed(4);
                            shittyFps = {
                                m: 0,
                                cT: 0
                            };
                        }
                    });
                    if (err != null) {
                        console.error(err)
                    }

                /* ======= */
                var fpsSelector = document.querySelector("[data-action='set-fps']");

                document.querySelector("[data-action='loop-start']").addEventListener("click", loop.start.bind(loop));
                document.querySelector("[data-action='loop-pause']").addEventListener("click", loop.pause.bind(loop));
                document.querySelector("[data-action='hide-logs']").addEventListener("click", logger.toggleLogs.bind(logger));

                fpsSelector.addEventListener("keypress", function(e) {
                    if (e.charCode == 13) {
                        loop.setFrequencies(parseInt(e.target.value));
                    }
                });
                fpsSelector.value = initialFPS;
            });
        </script>
    </body>
</html>
