<html>
    <head>
        <script type="text/javascript" src="../src/cycle.js"></script>
        <script type="text/javascript" src="../src/engine.js"></script>
        <script type="text/javascript" src="../src/render/color.js"></script>
        <script type="text/javascript" src="../src/render/pixel.js"></script>
        <script type="text/javascript" src="../src/anims/inquisition.js"></script>
        <script type="text/javascript" src="../src/updater.js"></script>
        <script type="text/javascript" src="../src/browser.js"></script>
        <script type="text/javascript" src="../src/logger.js"></script>
        <script type="text/javascript" src="../src/loop.js"></script>
        <style>
            #board {
                background-color: #eee;
            }
            </style>
    </head>
    <body>
        <button data-action="loop-start">Loop start</button>
        <button data-action="loop-pause">Loop pause</button>
        <button data-action="hide-logs">Toggle logs</button>
        FPS:
        <input type="text" data-action="set-fps" />
        <span data-display="crap">┬─┬ノ( º _ ºノ)</span>
        <div id="fpsData">
            <span id="fps"></span> fps <br />
            <span id="T"></span> ms/frame
        </div>
        
        <canvas id="board" width="1024" height="600"></canvas>

        <script type="text/javascript">
            document.addEventListener("DOMContentLoaded", function() {
                var initialFPS = 30,
                    engine = new Engine(document.querySelector("#board")),
                    loop = new Loop(initialFPS, engine),
                    logger = new Logger("info", false),
                    err = null,
                    shittyFps = {
                        m: 0,
                        cT: 0
                    };

                    loop.setMode("PLAY");

                    (new Browser())
                        .onDocumentHidden(loop.pause.bind(loop))
                        .onDocumentVisible(loop.start.bind(loop))
                        .onBlur(function(){document.querySelector('[data-display="crap"]').innerHTML = '(╯°□°）╯︵ ┻━┻';})
                        .onFocus(function(){document.querySelector('[data-display="crap"]').innerHTML = '┬─┬ノ( º _ ºノ)';});

                    loop.graphicUpdater.add("PLAY", function(engine) {
                       engine.clearCanvas();
                    });

                    err = loop.dataUpdater.add("PLAY", logger.log.bind(logger));
                    if (err != null) {
                        console.error(err);
                    }

                    err = loop.dataUpdater.add("PLAY", function(T) {
                        shittyFps.cT += T;
                        shittyFps.m++;
                        document.querySelector("#T").innerHTML = T.toFixed(4);

                        if (shittyFps.cT >= 100) {
                            document.querySelector("#fps").innerHTML = ((shittyFps.m / shittyFps.cT) * 1000).toFixed(4);
                            shittyFps = {
                                m: 0,
                                cT: 0
                            };
                        }
                    });
                    if (err != null) {
                        console.error(err);
                    }

                    var dummyT = 0,
                        dummyLock = true,
                        imgDataDummy = null;
                    loop.dataUpdater.add("PLAY", function(T) {
                        dummyT += T;
                        if (dummyT >= 0) {
                            dummyLock = false;
                            dummyT = 0
                        }
                    });
                    err = loop.graphicUpdater.add("PLAY", function(engine) {
                        if (dummyLock) {
                            return;
                        }
                        if (imgDataDummy) {
                            engine.drawImageData(imgDataDummy);
                        }
                        dummyLock = true;
                        var m = [6, 6],
                            sX = (Math.random() * 1024) << 0,
                            sY = (Math.random() * 600) << 0,
                            r = (Math.random() * 255) << 0,
                            g = (Math.random() * 255) << 0,
                            b = (Math.random() * 255) << 0,
                            a = Math.random();

                        if (sX > (1024 - m[0])) {
                            sX = 1024 - m[0];
                        }
                        
                        if (sY > (600 - m[1])) {
                            sY = 600 - m[1];
                        }


                        for (var x = 0; x < m[0]; x++) {
                            for (var y = 0; y < m[1]; y++) {
                                (new Pixel(sX + x, sY + y, new Color(r, g, b, a))).render(engine);
                            }
                        }
                        imgDataDummy = engine.c.getImageData(0, 0, 1024, 600);
                    });
                    if (err != null) {
                        console.error(err);
                    }

                /* ======= */
                var fpsSelector = document.querySelector("[data-action='set-fps']");

                document.querySelector("[data-action='loop-start']").addEventListener("click", loop.start.bind(loop));
                document.querySelector("[data-action='loop-pause']").addEventListener("click", loop.pause.bind(loop));
                document.querySelector("[data-action='hide-logs']").addEventListener("click", logger.toggleLogs.bind(logger));

                fpsSelector.addEventListener("keypress", function(e) {
                    if (e.charCode == 13) {
                        loop.setFrequencies(parseInt(e.target.value));
                    }
                });
                fpsSelector.value = initialFPS;
            });
        </script>
    </body>
</html>
